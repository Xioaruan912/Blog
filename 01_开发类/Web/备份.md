# 安装 rclone

```
bash <(curl -sSL https://raw.githubusercontent.com/Xioaruan912/Xcript/main/sh/rclone.sh)
```



```
root@hkbjnQPBC1HM:~# rclone config
No remotes found, make a new one?
n) New remote
s) Set configuration password
q) Quit config
n/s/q> n

Enter name for new remote.
name> backup

38 / Microsoft OneDrive
   \ (onedrive)
   
Storage> 38

Option client_id.
OAuth Client Id.
Leave blank normally.
Enter a value. Press Enter to leave empty.
client_id> 

Option client_secret.
OAuth Client Secret.
Leave blank normally.
Enter a value. Press Enter to leave empty.
client_secret> 

Option region.
Choose national cloud region for OneDrive.
Choose a number from below, or type in your own value of type string.
Press Enter for the default (global).
 1 / Microsoft Cloud Global
   \ (global)
 2 / Microsoft Cloud for US Government
   \ (us)
 3 / Microsoft Cloud Germany (deprecated - try global region first).
   \ (de)
 4 / Azure and Office 365 operated by Vnet Group in China
   \ (cn)
region> 1

Option tenant.
ID of the service principal's tenant. Also called its directory ID.
Set this if using
- Client Credential flow
Enter a value. Press Enter to leave empty.
tenant> 

Edit advanced config?
y) Yes
n) No (default)
y/n> 

Use web browser to automatically authenticate rclone with remote?
 * Say Y if the machine running rclone has a web browser you can use
 * Say N if running rclone on a (remote) machine without web browser access
If not sure try Y. If Y failed, try N.

y) Yes (default)
n) No
y/n> n

Option config_token.
For this to work, you will need rclone available on a machine that has
a web browser available.
For more help and alternate methods see: https://rclone.org/remote_setup/
Execute the following on the machine with the web browser (same rclone
version recommended):
        rclone authorize "onedrive"
Then paste the result.
Enter a value.
config_token>
```

现在回到 自己的设备 下载对应的 rclone

https://rclone.org/downloads/

如果你后续还需要用 就写入 `C:\Windows\System32`这个目录

执行`rclone authorize "onedrive"`

登入 直到

![image-20251207000509668](https://raw.githubusercontent.com/Xioaruan912/pic/main/image-20251207000509668.png)

回去控制台

![image-20251207000529192](https://raw.githubusercontent.com/Xioaruan912/pic/main/image-20251207000529192.png)

复制所有内容

粘贴回去即可

```
Option config_type.
Type of connection
Choose a number from below, or type in an existing value of type string.
Press Enter for the default (onedrive).
 1 / OneDrive Personal or Business
   \ (onedrive)
 2 / Root Sharepoint site
   \ (sharepoint)
   / Sharepoint site name or URL
 3 | E.g. mysite or https://contoso.sharepoint.com/sites/mysite
   \ (url)
 4 / Search for a Sharepoint site
   \ (search)
 5 / Type in driveID (advanced)
   \ (driveid)
 6 / Type in SiteID (advanced)
   \ (siteid)
   / Sharepoint server-relative path (advanced)
 7 | E.g. /teams/hr
   \ (path)
config_type> 1
Option config_driveid.
Select drive you want to use
Choose a number from below, or type in your own value of type string.
Press Enter for the default (b!unpUMXP5VEmYNSq_znGOxXKvnRWqwM9CpSYh931vUei_x0OnwygcTZNXkkdyR3sI).
 1 /  (personal)
   \ 
 2 / OneDrive (personal)
   \ ()
config_driveid> 2
```

后续选择回车即可

# 挂载本地

```
mkdir /onedrive
rclone mount onedrive: /onedrive --allow-other --allow-non-empty --vfs-cache-mode writes --daemon
```

`其中 onedrive 是 rclone 配置时输入的配置名称，/onedrive 是挂载目录，--daemon 是指后台运行。`

# 备份脚本

```sh
#!/bin/bash

# =========================================================
#  全交互式备份脚本 (无需修改代码，运行即可配置)
# =========================================================

# 获取脚本所在目录，配置文件将保存在这里
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
CONF_FILE="$SCRIPT_DIR/backup.conf"

# 颜色定义
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# =========================================================
#  函数：配置向导 (生成配置文件)
# =========================================================
configure_wizard() {
    clear
    echo -e "${BLUE}############################################${NC}"
    echo -e "${BLUE}#      欢迎使用 X-Backup 配置向导          #${NC}"
    echo -e "${BLUE}############################################${NC}"
    echo -e "配置文件将保存在: $CONF_FILE\n"

    # 1. 设置本地备份目录
    read -e -p "1. 本地备份存放目录 (默认: /root/backup): " INPUT_DIR
    LOCAL_DIR="${INPUT_DIR:-/root/backup}"
    
    # 2. 设置 Rclone 远程
    echo -e "\n2. Rclone 远程配置 (例如: onedrive:backup)"
    echo -e "   如果没有配置 Rclone 或只想本地备份，请直接回车跳过。"
    read -e -p "   请输入 Rclone 名称: " INPUT_REMOTE
    REMOTE_DEST="$INPUT_REMOTE"

    # 3. 设置保留天数
    echo -e "\n3. 备份保留策略"
    read -e -p "   本地保留几天? (默认: 7): " INPUT_LDAY
    KEEP_LOCAL="${INPUT_LDAY:-7}"
    
    if [ -n "$REMOTE_DEST" ]; then
        read -e -p "   远程保留几天? (默认: 15): " INPUT_RDAY
        KEEP_REMOTE="${INPUT_RDAY:-15}"
    else
        KEEP_REMOTE=0
    fi

    # 4. 循环添加备份项目
    echo -e "\n4. 添加要备份的文件或目录 (输入完一个回车，直接回车结束)"
    BACKUP_ITEMS=()
    while true; do
        read -e -p "   请输入路径 (结束请回车): " ITEM_PATH
        if [ -z "$ITEM_PATH" ]; then
            break
        fi
        
        # 简单检查路径是否存在
        if [ ! -e "$ITEM_PATH" ]; then
            echo -e "   ${YELLOW}[警告] 路径不存在: $ITEM_PATH (但已添加到列表)${NC}"
        else
            echo -e "   ${GREEN}[已添加] $ITEM_PATH${NC}"
        fi
        BACKUP_ITEMS+=("$ITEM_PATH")
    done

    # 如果没有添加任何项目
    if [ ${#BACKUP_ITEMS[@]} -eq 0 ]; then
        echo -e "\n${RED}[错误] 未配置任何备份项目，退出。${NC}"
        exit 1
    fi

    # 5. 生成配置文件
    echo -e "\n正在生成配置文件..."
    
    cat > "$CONF_FILE" <<EOF
# X-Backup 配置文件 (由脚本自动生成)
# 生成时间: $(date)

# 本地备份根目录
BACKUP_ROOT="$LOCAL_DIR"

# 远程 Rclone 路径 (留空则不上传)
REMOTE_DEST="$REMOTE_DEST"

# 保留天数
KEEP_LOCAL=$KEEP_LOCAL
KEEP_REMOTE=$KEEP_REMOTE

# 备份列表 (数组格式)
BACKUP_LIST=(
EOF

    # 写入数组内容
    for item in "${BACKUP_ITEMS[@]}"; do
        echo "    \"$item\"" >> "$CONF_FILE"
    done

    echo ")" >> "$CONF_FILE"

    echo -e "${GREEN}[成功] 配置已保存！${NC}"
    echo -e "您可以随时运行 ${YELLOW}bash $0 config${NC} 重新配置。"
    echo -e "-----------------------------------------------------\n"
}

# =========================================================
#  函数：执行备份任务
# =========================================================
run_backup() {
    # 读取配置
    source "$CONF_FILE"
    
    DATE_STR=$(date +'%Y-%m-%d')
    TODAY_DIR="$BACKUP_ROOT/$DATE_STR"
    mkdir -p "$TODAY_DIR"

    echo -e "${BLUE}[INFO] 开始备份任务: $DATE_STR${NC}"

    # 1. 执行打包
    for SRC in "${BACKUP_LIST[@]}"; do
        NAME=$(basename "$SRC")
        TARGET="$TODAY_DIR/${NAME}_${DATE_STR}.tar.gz"
        
        if [ -e "$SRC" ]; then
            tar -czPf "$TARGET" "$SRC" 2>/dev/null
            if [ $? -eq 0 ]; then
                echo -e "  [备份成功] $SRC -> $TARGET"
            else
                echo -e "  ${RED}[备份失败] $SRC (Tar error)${NC}"
            fi
        else
            echo -e "  ${YELLOW}[跳过] 源路径不存在: $SRC${NC}"
        fi
    done

    # 2. Rclone 上传
    if [ -n "$REMOTE_DEST" ]; then
        echo -e "${BLUE}[INFO] 正在上传到远程: $REMOTE_DEST${NC}"
        rclone copy "$TODAY_DIR" "$REMOTE_DEST/$DATE_STR" --log-level ERROR
    fi

    # 3. 清理本地
    echo -e "${BLUE}[INFO] 清理本地旧备份 (保留 $KEEP_LOCAL 天)${NC}"
    find "$BACKUP_ROOT" -mindepth 1 -maxdepth 1 -type d -mtime +$KEEP_LOCAL -exec rm -rf {} \;

    # 4. 清理远程
    if [ -n "$REMOTE_DEST" ]; then
        echo -e "${BLUE}[INFO] 清理远程旧备份 (保留 $KEEP_REMOTE 天)${NC}"
        # 简单计算截止时间戳
        CUTOFF_TS=$(date -d "-$KEEP_REMOTE days" +%s)
        REMOTE_DIRS=$(rclone lsf "$REMOTE_DEST" --dirs-only 2>/dev/null)
        
        for R_DIR in $REMOTE_DIRS; do
            DIR_NAME=${R_DIR%/}
            if [[ "$DIR_NAME" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
                DIR_TS=$(date -d "$DIR_NAME" +%s 2>/dev/null)
                if [[ -n "$DIR_TS" && $DIR_TS -lt $CUTOFF_TS ]]; then
                    echo "  删除远程: $DIR_NAME"
                    rclone purge "$REMOTE_DEST/$DIR_NAME" 2>/dev/null
                fi
            fi
        done
    fi
    
    echo -e "${GREEN}[完成] 所有任务执行完毕。${NC}"
}

# =========================================================
#  主逻辑入口
# =========================================================

# 如果带参数 config，或者配置文件不存在，则进入配置向导
if [ "$1" == "config" ] || [ ! -f "$CONF_FILE" ]; then
    configure_wizard
    
    read -p "是否立即运行一次备份? (y/n): " RUN_NOW
    if [[ "$RUN_NOW" != "y" ]]; then
        echo "已退出。以后只需运行 bash $0 即可自动备份。"
        exit 0
    fi
fi

# 运行备份
run_backup
```

```sh
bash backup.sh
```

```sh
############################################
#      欢迎使用 X-Backup 配置向导          #
############################################
配置文件将保存在: /root/backup/backup.conf

1. 本地备份存放目录 (默认: /root/backup): 

2. Rclone 远程配置 (例如: onedrive:backup)
   如果没有配置 Rclone 或只想本地备份，请直接回车跳过。
   请输入 Rclone 名称: onedrive:backup

3. 备份保留策略
   本地保留几天? (默认: 7): 2
   远程保留几天? (默认: 15): 7

4. 添加要备份的文件或目录 (输入完一个回车，直接回车结束)
   请输入路径 (结束请回车): /var/www/html
   [已添加] /var/www/html
   请输入路径 (结束请回车): 

正在生成配置文件...
[成功] 配置已保存！
您可以随时运行 bash ./backup.sh config 重新配置。
-----------------------------------------------------

是否立即运行一次备份? (y/n): y
[INFO] 开始备份任务: 2025-12-06
  [备份成功] /var/www/html -> /root/backup/2025-12-06/html_2025-12-06.tar.gz
[INFO] 正在上传到远程: onedrive:backup
[INFO] 清理本地旧备份 (保留 2 天)
[INFO] 清理远程旧备份 (保留 7 天)
[完成] 所有任务执行完毕。
root@:~/backup#
```

# 添加计划任务

```sh
crontab -e
0 3 * * * /root/backup/backup.sh >> /root/backup/backup.log 2>&1
```

到此一个备份系统就完全结束了